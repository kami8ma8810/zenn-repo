<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Googleå¼ã‚¯ãƒ­ãƒƒãƒ‘ãƒ¼ ãƒ‡ãƒ¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
      color: #333;
    }

    .info {
      margin-bottom: 20px;
      color: #666;
      font-size: 14px;
      text-align: center;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #1557b0;
    }

    button:active {
      background: #0d47a1;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ãƒœã‚¿ãƒ³ */
    .debug-only {
      display: none;
    }

    body.debug-mode .debug-only {
      display: inline-block;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cropper-container {
      position: relative;
      width: 840px;
      height: 840px;
      background: #000;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠï¼ˆå›è»¢ç”¨ï¼‰ - ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã¨åŒã˜ã‚µã‚¤ã‚ºã®æ­£æ–¹å½¢ */
    .image-container {
      position: absolute;
      /* left/top ã¯ JavaScript ã§è¨­å®šï¼ˆã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã¨åŒã˜ä½ç½®ï¼‰ */
      width: 632px;
      height: 632px;
      transition: transform 100ms linear;
      transform-origin: center;
      overflow: visible; /* ã¯ã¿å‡ºã—ã‚’è¨±å¯ */
    }

    /* ç”»åƒï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚ºãƒ¼ãƒ ç”¨ï¼‰ */
    .cropper-image {
      position: absolute;
      top: 0;
      left: 0;
      /* å…ƒã®ç”»åƒã‚µã‚¤ã‚ºã®ã¾ã¾ï¼ˆmax-widthã§åˆ¶é™ï¼‰ */
      max-width: none;
      max-height: none;
      cursor: grab;
      user-select: none;
      transform-origin: 50% 50%; /* ä¸­å¿ƒã‚’åŸºæº–ç‚¹ã«ï¼ˆGoogleã¨åŒã˜ï¼‰ */
      transition: transform 100ms linear;
    }

    .cropper-image.dragging {
      cursor: grabbing;
      transition: none !important;
    }

    /* ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸï¼ˆã‚µã‚¤ã‚ºå¯å¤‰ï¼‰ */
    .crop-area {
      position: absolute;
      left: 104px;
      top: 174px;
      width: 632px;
      height: 632px;
      pointer-events: none;
      z-index: 10;
      transition: all 100ms linear;
    }

    /* SVG ãƒã‚¹ã‚¯ï¼ˆå††å½¢ï¼‰ */
    .crop-mask {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .crop-mask-path {
      fill: rgba(0, 0, 0, 0.5);
    }

    /* ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®æ ç·š */
    .crop-border {
      position: absolute;
      inset: 0;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }

    /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
    .resize-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid #1a73e8;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      z-index: 20;
      transition: transform 0.2s;
    }

    .resize-handle:hover {
      transform: scale(1.2);
    }

    .resize-handle:active {
      transform: scale(1.3);
      background: #e3f2fd;
    }

    .resize-handle.top-left {
      top: -10px;
      left: -10px;
      cursor: nwse-resize;
    }

    .resize-handle.top-right {
      top: -10px;
      right: -10px;
      cursor: nesw-resize;
    }

    .resize-handle.bottom-left {
      bottom: -10px;
      left: -10px;
      cursor: nesw-resize;
    }

    .resize-handle.bottom-right {
      bottom: -10px;
      right: -10px;
      cursor: nwse-resize;
    }

    /* ä¸‰åˆ†å‰²æ³•ã‚°ãƒªãƒƒãƒ‰ */
    .grid-overlay {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 5;
    }

    .grid-overlay.visible {
      opacity: 1;
    }

    .grid-line {
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
    }

    .grid-line.horizontal {
      left: 0;
      right: 0;
      height: 1px;
    }

    .grid-line.vertical {
      top: 0;
      bottom: 0;
      width: 1px;
    }

    /* æƒ…å ±è¡¨ç¤º */
    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      color: #333;
      max-width: 840px;
      width: 100%;
    }

    .debug-info div {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ Googleå¼ã‚¯ãƒ­ãƒƒãƒ‘ãƒ¼ ãƒ‡ãƒ¢</h1>
  <p class="info">
    ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§ç”»åƒã‚’ç§»å‹• | ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  | å›è»¢ãƒœã‚¿ãƒ³ã§-90åº¦å›è»¢
  </p>

  <div class="controls">
    <button id="rotateBtn">â†º å·¦ã«å›è»¢</button>
    <button id="resetBtn">â†» ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="verticalBtn" class="debug-only">ğŸ“ ç¸¦é•·ç”»åƒ</button>
    <button id="horizontalBtn" class="debug-only">ğŸ“ æ¨ªé•·ç”»åƒ</button>
    <button id="squareBtn" class="debug-only">â¬œ æ­£æ–¹å½¢ç”»åƒ</button>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="cropper-container" id="cropperContainer">
    <!-- ç”»åƒã‚³ãƒ³ãƒ†ãƒŠï¼ˆå›è»¢ç”¨ï¼‰ -->
    <div class="image-container" id="imageContainer">
      <img
        id="cropperImage"
        class="cropper-image"
        src="https://picsum.photos/640/1136"
        alt="Sample image"
        draggable="false"
      />
    </div>

    <!-- ä¸‰åˆ†å‰²æ³•ã‚°ãƒªãƒƒãƒ‰ -->
    <div class="grid-overlay" id="gridOverlay">
      <div class="grid-line horizontal" style="top: 33.33%"></div>
      <div class="grid-line horizontal" style="top: 66.67%"></div>
      <div class="grid-line vertical" style="left: 33.33%"></div>
      <div class="grid-line vertical" style="left: 66.67%"></div>
    </div>

    <!-- ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸ -->
    <div class="crop-area" id="cropArea">
      <div class="crop-border"></div>
      <!-- ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« -->
      <div class="resize-handle top-left" data-handle="top-left"></div>
      <div class="resize-handle top-right" data-handle="top-right"></div>
      <div class="resize-handle bottom-left" data-handle="bottom-left"></div>
      <div class="resize-handle bottom-right" data-handle="bottom-right"></div>
    </div>
  </div>

  <div class="debug-info">
    <div><strong>ç¾åœ¨ã®çŠ¶æ…‹:</strong></div>
    <div id="debugTransform">transform: translate(0px, 0px) scale(1)</div>
    <div id="debugRotation">rotation: 0deg</div>
    <div id="debugCropRange">åˆ‡ã‚ŠæŠœãç¯„å›²: è¨ˆç®—ä¸­...</div>
  </div>

  <script>
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®æ¤œå‡º
    const urlParams = new URLSearchParams(window.location.search);
    const isDebugMode = urlParams.get('debug') === 'true';
    if (isDebugMode) {
      document.body.classList.add('debug-mode');
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®åˆ¶å¾¡
    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading() {
      loadingOverlay.classList.add('active');
    }
    function hideLoading() {
      loadingOverlay.classList.remove('active');
    }

    // çŠ¶æ…‹ç®¡ç†
    const state = {
      // ç”»åƒã® transform
      x: 0,
      y: 0,
      scale: 1,

      // å›è»¢è§’åº¦
      rotation: 0,

      // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹
      isDragging: false,
      startX: 0,
      startY: 0,
      startTransformX: 0,
      startTransformY: 0,

      // ãƒªã‚µã‚¤ã‚ºçŠ¶æ…‹
      isResizing: false,
      resizeHandle: null,
      startCropWidth: 0,
      startCropHeight: 0,
      startCropLeft: 0,
      startCropTop: 0,
      pendingCropSize: null, // æ‹¡å¤§æ–¹å‘ã®å ´åˆã€ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—å¾Œã«é©ç”¨
    };

    // DOM è¦ç´ 
    const cropperContainer = document.getElementById('cropperContainer');
    const imageContainer = document.getElementById('imageContainer');
    const cropperImage = document.getElementById('cropperImage');
    const gridOverlay = document.getElementById('gridOverlay');
    const cropArea = document.getElementById('cropArea');
    const rotateBtn = document.getElementById('rotateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const verticalBtn = document.getElementById('verticalBtn');
    const horizontalBtn = document.getElementById('horizontalBtn');
    const squareBtn = document.getElementById('squareBtn');
    const resizeHandles = document.querySelectorAll('.resize-handle');

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    const debugTransform = document.getElementById('debugTransform');
    const debugRotation = document.getElementById('debugRotation');
    const debugCropRange = document.getElementById('debugCropRange');

    // â­ ãƒªãƒ­ãƒ¼ãƒ‰ã®ãŸã³ã«ç”»åƒã‚’é †ç•ªã«åˆ‡ã‚Šæ›¿ãˆï¼ˆç¸¦é•·â†’æ¨ªé•·â†’æ­£æ–¹å½¢â†’ç¸¦é•·...ï¼‰
    const IMAGE_TYPES = {
      vertical: { width: 640, height: 1136, label: 'ç¸¦é•·' },
      horizontal: { width: 1136, height: 640, label: 'æ¨ªé•·' },
      square: { width: 800, height: 800, label: 'æ­£æ–¹å½¢' },
    };
    const IMAGE_TYPE_ORDER = ['vertical', 'horizontal', 'square'];

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ¬¡ã®ç”»åƒã‚¿ã‚¤ãƒ—ã«åˆ‡ã‚Šæ›¿ãˆ
    function rotateImageOnLoad() {
      const currentType = localStorage.getItem('currentImageType') || 'square'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ squareï¼ˆæ¬¡ãŒ vertical ã«ãªã‚‹ï¼‰
      const currentIndex = IMAGE_TYPE_ORDER.indexOf(currentType);
      const nextIndex = (currentIndex + 1) % IMAGE_TYPE_ORDER.length;
      const nextType = IMAGE_TYPE_ORDER[nextIndex];
      const nextImage = IMAGE_TYPES[nextType];

      // localStorage ã«ä¿å­˜
      localStorage.setItem('currentImageType', nextType);

      // ç”»åƒã‚’è¨­å®š
      cropperImage.src = `https://picsum.photos/${nextImage.width}/${nextImage.height}?random=${Date.now()}`;
      console.log(`ğŸ”„ ç”»åƒã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ: ${IMAGE_TYPES[currentType]?.label || 'åˆå›'} â†’ ${nextImage.label} (${nextImage.width}Ã—${nextImage.height})`);
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
    rotateImageOnLoad();

    // ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®æƒ…å ±ï¼ˆåˆæœŸå€¤ï¼‰
    const CROP_AREA_INITIAL = {
      left: 104,
      top: 174,
      width: 632,
      height: 632,
    };

    // ç¾åœ¨ã®ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸï¼ˆå¯å¤‰ï¼‰
    let cropAreaState = { ...CROP_AREA_INITIAL };

    // ç”»åƒã®å…ƒã®ã‚µã‚¤ã‚º
    let IMAGE_WIDTH = 800;
    let IMAGE_HEIGHT = 600;
    let INITIAL_SCALE = 1;
    let INITIAL_TRANSLATE_X = 0;
    let INITIAL_TRANSLATE_Y = 0;

    // ç”»åƒèª­ã¿è¾¼ã¿å¾Œã«ã‚µã‚¤ã‚ºã‚’å–å¾—ã—ã€åˆæœŸé…ç½®ã‚’è¨ˆç®—
    cropperImage.addEventListener('load', () => {
      const naturalWidth = cropperImage.naturalWidth;
      const naturalHeight = cropperImage.naturalHeight;

      IMAGE_WIDTH = naturalWidth;
      IMAGE_HEIGHT = naturalHeight;

      // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®ã‚’ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã¨åŒã˜ã«ã™ã‚‹
      imageContainer.style.left = `${CROP_AREA_INITIAL.left}px`;
      imageContainer.style.top = `${CROP_AREA_INITIAL.top}px`;

      // çŸ­è¾ºã‚’ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã«åˆã‚ã›ã‚‹åˆæœŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨ˆç®—
      const cropAreaSize = CROP_AREA_INITIAL.width;
      const minDimension = Math.min(naturalWidth, naturalHeight);
      INITIAL_SCALE = cropAreaSize / minDimension;

      // transform-origin ãŒ 50% 50% ã®å ´åˆã® translate è¨ˆç®—
      // ç”»åƒã¯ top: 0, left: 0 ã«é…ç½®ã•ã‚Œã€ãã®ä¸­å¿ƒã‹ã‚‰ transform ãŒè¡Œã‚ã‚Œã‚‹
      // ç”»åƒã®ä¸­å¿ƒï¼ˆnatural sizeï¼‰
      const imageCenterX = naturalWidth / 2;
      const imageCenterY = naturalHeight / 2;

      // Container ã®ä¸­å¿ƒ
      const containerCenterX = cropAreaSize / 2;
      const containerCenterY = cropAreaSize / 2;

      // ç”»åƒä¸­å¿ƒã‚’ container ä¸­å¿ƒã«åˆã‚ã›ã‚‹ãŸã‚ã® translate
      INITIAL_TRANSLATE_X = containerCenterX - imageCenterX;
      INITIAL_TRANSLATE_Y = containerCenterY - imageCenterY;

      // åˆæœŸçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      state.x = 0;
      state.y = 0;
      state.scale = INITIAL_SCALE;

      applyTransform(false);
      updateDebugInfo();
    });

    // Transform ã‚’é©ç”¨
    function applyTransform(withTransition = true) {
      cropperImage.style.transition = withTransition ? 'transform 100ms linear' : 'none';

      // åˆæœŸé…ç½®ï¼ˆä¸­å¤®ï¼‰ + ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•é‡ã‚’åˆç®—
      const totalTranslateX = INITIAL_TRANSLATE_X + state.x;
      const totalTranslateY = INITIAL_TRANSLATE_Y + state.y;

      cropperImage.style.transform = `translate(${totalTranslateX}px, ${totalTranslateY}px) scale(${state.scale})`;

      imageContainer.style.transition = withTransition ? 'transform 100ms linear' : 'none';
      imageContainer.style.transform = `rotate(${state.rotation}deg)`;

      updateDebugInfo();
    }

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
    function updateDebugInfo() {
      const totalTranslateX = INITIAL_TRANSLATE_X + state.x;
      const totalTranslateY = INITIAL_TRANSLATE_Y + state.y;

      debugTransform.textContent = `transform: translate(${totalTranslateX.toFixed(2)}px, ${totalTranslateY.toFixed(2)}px) scale(${state.scale.toFixed(4)})`;
      debugRotation.textContent = `rotation: ${state.rotation}deg`;

      // åˆ‡ã‚ŠæŠœãç¯„å›²ã®è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const cropWidth = cropAreaState.width / state.scale;
      const cropHeight = cropAreaState.height / state.scale;

      debugCropRange.textContent = `åˆ‡ã‚ŠæŠœãç¯„å›²ï¼ˆæ¦‚ç®—ï¼‰: ${cropWidth.toFixed(0)}px Ã— ${cropHeight.toFixed(0)}px`;
    }

    // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ï¼ˆãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼‰
    cropperImage.addEventListener('mousedown', (e) => {
      state.isDragging = true;
      state.startX = e.clientX;
      state.startY = e.clientY;
      state.startTransformX = state.x;
      state.startTransformY = state.y;

      cropperImage.classList.add('dragging');
      gridOverlay.classList.add('visible');

      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ transition ã‚’ç„¡åŠ¹åŒ–
      applyTransform(false);
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ç¯„å›²ã®åˆ¶é™ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    // scale: ä½¿ç”¨ã™ã‚‹ scaleï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ state.scaleï¼‰
    function clampTranslate(x, y, scale = state.scale) {
      // ã‚¹ã‚±ãƒ¼ãƒ«å¾Œã®ç”»åƒã‚µã‚¤ã‚º
      const scaledWidth = IMAGE_WIDTH * scale;
      const scaledHeight = IMAGE_HEIGHT * scale;

      // Container ã‚µã‚¤ã‚º
      const containerWidth = cropAreaState.width;
      const containerHeight = cropAreaState.height;

      // transform-origin: 50% 50% ã®å ´åˆã®ç”»åƒå·¦ä¸Šã®ä½ç½®
      // ç”»åƒå·¦ä¸Š = (IMAGE_WIDTH/2 * (1 - scale), IMAGE_HEIGHT/2 * (1 - scale)) + translate
      const imageLeft = IMAGE_WIDTH / 2 * (1 - scale) + INITIAL_TRANSLATE_X + x;
      const imageTop = IMAGE_HEIGHT / 2 * (1 - scale) + INITIAL_TRANSLATE_Y + y;

      // åˆ¶é™æ¡ä»¶ï¼šç”»åƒãŒã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã‚’å®Œå…¨ã«ã‚«ãƒãƒ¼ã™ã‚‹
      // total translate ã®æœ€å¤§å€¤ãƒ»æœ€å°å€¤
      const maxTotalTx = -IMAGE_WIDTH / 2 * (1 - scale);
      const minTotalTx = containerWidth - IMAGE_WIDTH / 2 * (1 + scale);
      const maxTotalTy = -IMAGE_HEIGHT / 2 * (1 - scale);
      const minTotalTy = containerHeight - IMAGE_HEIGHT / 2 * (1 + scale);

      // state.x/y ã®åˆ¶é™
      const minX = minTotalTx - INITIAL_TRANSLATE_X;
      const maxX = maxTotalTx - INITIAL_TRANSLATE_X;
      const minY = minTotalTy - INITIAL_TRANSLATE_Y;
      const maxY = maxTotalTy - INITIAL_TRANSLATE_Y;

      return {
        x: Math.max(minX, Math.min(maxX, x)),
        y: Math.max(minY, Math.min(maxY, y))
      };
    }

    // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ï¼‰
    document.addEventListener('mousemove', (e) => {
      if (!state.isDragging) return;

      const deltaX = e.clientX - state.startX;
      const deltaY = e.clientY - state.startY;

      const newX = state.startTransformX + deltaX;
      const newY = state.startTransformY + deltaY;

      // ãƒ‰ãƒ©ãƒƒã‚°ç¯„å›²ã‚’åˆ¶é™
      const clamped = clampTranslate(newX, newY);
      state.x = clamped.x;
      state.y = clamped.y;

      applyTransform(false);
    });

    // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ï¼ˆãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ï¼‰
    document.addEventListener('mouseup', () => {
      if (!state.isDragging) return;

      state.isDragging = false;
      cropperImage.classList.remove('dragging');
      gridOverlay.classList.remove('visible');

      // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã¯ transition ã‚’æœ‰åŠ¹åŒ–
      applyTransform(true);
    });

    // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ ï¼‰
    cropperContainer.addEventListener('wheel', (e) => {
      e.preventDefault();

      // ã‚ºãƒ¼ãƒ å€ç‡ã®è¨ˆç®—ï¼ˆINITIAL_SCALEä»¥ä¸Šã€INITIAL_SCALEã®5å€ä»¥ä¸‹ï¼‰
      // åˆæœŸçŠ¶æ…‹ã‚ˆã‚Šå°ã•ãã™ã‚‹ã¨ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã«ç”»åƒå¤–ã®éƒ¨åˆ†ãŒå…¥ã£ã¦ã—ã¾ã†ãŸã‚ã€INITIAL_SCALEãŒæœ€å°å€¤
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = Math.max(INITIAL_SCALE, Math.min(state.scale * delta, INITIAL_SCALE * 5));

      // scale ã®å¤‰åŒ–ç‡
      const scaleRatio = newScale / state.scale;

      // Container ã®ä¸­å¿ƒ
      const containerCenterX = cropAreaState.width / 2;
      const containerCenterY = cropAreaState.height / 2;

      // ç”»åƒã®ä¸­å¿ƒï¼ˆnatural sizeï¼‰
      const imageCenterX = IMAGE_WIDTH / 2;
      const imageCenterY = IMAGE_HEIGHT / 2;

      // â­ ç”»åƒã®ç¾åœ¨ä½ç½®ã«å¿œã˜ã¦ã‚ºãƒ¼ãƒ ã®åŸºæº–ç‚¹ã‚’å‹•çš„ã«èª¿æ•´
      //
      // ç›®æ¨™: ç”»åƒãŒç«¯ã«ã„ã‚‹å ´åˆã€ãã®ã‚¨ãƒƒã‚¸ã‚’å††ã®ç«¯ã«å›ºå®šã—ãŸã¾ã¾ã‚ºãƒ¼ãƒ ã™ã‚‹
      //
      // ã‚¨ãƒƒã‚¸ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°ã®è¨ˆç®—:
      // - å·¦ç«¯å›ºå®š: ç”»åƒã®å·¦ç«¯åº§æ¨™ã‚’ä¸€å®šã«ä¿ã¤
      // - å³ç«¯å›ºå®š: ç”»åƒã®å³ç«¯åº§æ¨™ã‚’ä¸€å®šã«ä¿ã¤
      // - ä¸Šç«¯å›ºå®š: ç”»åƒã®ä¸Šç«¯åº§æ¨™ã‚’ä¸€å®šã«ä¿ã¤
      // - ä¸‹ç«¯å›ºå®š: ç”»åƒã®ä¸‹ç«¯åº§æ¨™ã‚’ä¸€å®šã«ä¿ã¤

      // ç¾åœ¨ã® total translateï¼ˆINITIAL_TRANSLATE + stateï¼‰ã‚’å–å¾—
      const currentTotalTranslateX = INITIAL_TRANSLATE_X + state.x;
      const currentTotalTranslateY = INITIAL_TRANSLATE_Y + state.y;

      // ç¾åœ¨ã® state ãŒå¢ƒç•Œã«ã„ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã€å¢ƒç•Œå€¤ã‚’è¨ˆç®—
      const maxTotalTx = -IMAGE_WIDTH / 2 * (1 - state.scale);
      const minTotalTx = cropAreaState.width - IMAGE_WIDTH / 2 * (1 + state.scale);
      const maxTotalTy = -IMAGE_HEIGHT / 2 * (1 - state.scale);
      const minTotalTy = cropAreaState.height - IMAGE_HEIGHT / 2 * (1 + state.scale);

      const minX = minTotalTx - INITIAL_TRANSLATE_X;
      const maxX = maxTotalTx - INITIAL_TRANSLATE_X;
      const minY = minTotalTy - INITIAL_TRANSLATE_Y;
      const maxY = maxTotalTy - INITIAL_TRANSLATE_Y;

      const EPSILON = 0.1; // èª¤å·®è¨±å®¹ç¯„å›²
      const atLeftEdge = Math.abs(state.x - maxX) < EPSILON;
      const atRightEdge = Math.abs(state.x - minX) < EPSILON;
      const atTopEdge = Math.abs(state.y - maxY) < EPSILON;
      const atBottomEdge = Math.abs(state.y - minY) < EPSILON;

      // ç”»åƒã®å‘ãã‚’åˆ¤å®šï¼ˆé•·è¾ºæ–¹å‘ã®ã¿ã‚¨ãƒƒã‚¸å›ºå®šã€çŸ­è¾ºæ–¹å‘ã¯ä¸­å¤®å›ºå®šï¼‰
      const isVertical = IMAGE_HEIGHT > IMAGE_WIDTH; // ç¸¦é•·ç”»åƒ
      const isHorizontal = IMAGE_WIDTH > IMAGE_HEIGHT; // æ¨ªé•·ç”»åƒ

      // ã‚¨ãƒƒã‚¸ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°è¨ˆç®—
      let newTotalTranslateX, newTotalTranslateY;

      // Xæ–¹å‘: æ¨ªé•·ç”»åƒã®å ´åˆã®ã¿ã‚¨ãƒƒã‚¸å›ºå®šã€ç¸¦é•·ç”»åƒã§ã¯å¸¸ã«ä¸­å¤®å›ºå®š
      if (isHorizontal && atLeftEdge) {
        // å·¦ç«¯å›ºå®š: ç”»åƒã®å·¦ç«¯åº§æ¨™ = imageCenterX + totalTranslateX - IMAGE_WIDTH/2 * scale ã‚’ä¸€å®šã«ä¿ã¤
        newTotalTranslateX = currentTotalTranslateX + IMAGE_WIDTH / 2 * (newScale - state.scale);
      } else if (isHorizontal && atRightEdge) {
        // å³ç«¯å›ºå®š: ç”»åƒã®å³ç«¯åº§æ¨™ = imageCenterX + totalTranslateX + IMAGE_WIDTH/2 * scale ã‚’ä¸€å®šã«ä¿ã¤
        newTotalTranslateX = currentTotalTranslateX + IMAGE_WIDTH / 2 * (state.scale - newScale);
      } else {
        // ä¸­å¤®å›ºå®š: ã‚¯ãƒ­ãƒƒãƒ—ä¸­å¿ƒãŒè¦‹ã¦ã„ã‚‹ç”»åƒä¸Šã®Xåº§æ¨™ã‚’å›ºå®š
        const currentImageX = (containerCenterX - imageCenterX - currentTotalTranslateX) / state.scale + imageCenterX;
        newTotalTranslateX = containerCenterX - imageCenterX - (currentImageX - imageCenterX) * newScale;
      }

      // Yæ–¹å‘: ç¸¦é•·ç”»åƒã®å ´åˆã®ã¿ã‚¨ãƒƒã‚¸å›ºå®šã€æ¨ªé•·ç”»åƒã§ã¯å¸¸ã«ä¸­å¤®å›ºå®š
      if (isVertical && atTopEdge) {
        // ä¸Šç«¯å›ºå®š: ç”»åƒã®ä¸Šç«¯åº§æ¨™ = imageCenterY + totalTranslateY - IMAGE_HEIGHT/2 * scale ã‚’ä¸€å®šã«ä¿ã¤
        newTotalTranslateY = currentTotalTranslateY + IMAGE_HEIGHT / 2 * (newScale - state.scale);
      } else if (isVertical && atBottomEdge) {
        // ä¸‹ç«¯å›ºå®š: ç”»åƒã®ä¸‹ç«¯åº§æ¨™ = imageCenterY + totalTranslateY + IMAGE_HEIGHT/2 * scale ã‚’ä¸€å®šã«ä¿ã¤
        newTotalTranslateY = currentTotalTranslateY + IMAGE_HEIGHT / 2 * (state.scale - newScale);
      } else {
        // ä¸­å¤®å›ºå®š: ã‚¯ãƒ­ãƒƒãƒ—ä¸­å¿ƒãŒè¦‹ã¦ã„ã‚‹ç”»åƒä¸Šã®Yåº§æ¨™ã‚’å›ºå®š
        const currentImageY = (containerCenterY - imageCenterY - currentTotalTranslateY) / state.scale + imageCenterY;
        newTotalTranslateY = containerCenterY - imageCenterY - (currentImageY - imageCenterY) * newScale;
      }

      // state ã«æˆ»ã™ï¼ˆINITIAL_TRANSLATE ã‚’å¼•ãï¼‰
      const newX = newTotalTranslateX - INITIAL_TRANSLATE_X;
      const newY = newTotalTranslateY - INITIAL_TRANSLATE_Y;

      // â­ é‡è¦: ã‚ºãƒ¼ãƒ å¾Œã®ãƒ‰ãƒ©ãƒƒã‚°ç¯„å›²ã‚’åˆ¶é™ï¼ˆnewScale ã‚’æ¸¡ã™ï¼‰
      // state.scale ã‚’æ›´æ–°ã™ã‚‹å‰ã«ã€newScale ã‚’ä½¿ã£ã¦åˆ¶é™ã‚’è¨ˆç®—ã™ã‚‹
      const clamped = clampTranslate(newX, newY, newScale);
      state.x = clamped.x;
      state.y = clamped.y;
      state.scale = newScale;

      // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã¯å¸¸ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      applyTransform(true);
    });

    // å›è»¢ãƒœã‚¿ãƒ³
    rotateBtn.addEventListener('click', () => {
      state.rotation -= 90;
      // 360åº¦ã§æ­£è¦åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      if (state.rotation <= -360) {
        state.rotation = 0;
      }
      applyTransform(true);
    });

    // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    resizeHandles.forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation(); // ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«

        state.isResizing = true;
        state.resizeHandle = handle.dataset.handle;
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startCropWidth = cropAreaState.width;
        state.startCropHeight = cropAreaState.height;
        state.startCropLeft = cropAreaState.left;
        state.startCropTop = cropAreaState.top;

        gridOverlay.classList.add('visible');
      });
    });

    // ãƒªã‚µã‚¤ã‚ºä¸­ã®å‡¦ç†
    document.addEventListener('mousemove', (e) => {
      if (!state.isResizing) return;

      const deltaX = e.clientX - state.startX;
      const deltaY = e.clientY - state.startY;

      let newWidth = state.startCropWidth;
      let newHeight = state.startCropHeight;
      let newLeft = state.startCropLeft;
      let newTop = state.startCropTop;

      // ãƒãƒ³ãƒ‰ãƒ«ã®ä½ç½®ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºã‚’å¤‰æ›´
      switch (state.resizeHandle) {
        case 'top-left':
          newWidth = state.startCropWidth - deltaX;
          newHeight = state.startCropHeight - deltaY;
          newLeft = state.startCropLeft + deltaX;
          newTop = state.startCropTop + deltaY;
          break;
        case 'top-right':
          newWidth = state.startCropWidth + deltaX;
          newHeight = state.startCropHeight - deltaY;
          newTop = state.startCropTop + deltaY;
          break;
        case 'bottom-left':
          newWidth = state.startCropWidth - deltaX;
          newHeight = state.startCropHeight + deltaY;
          newLeft = state.startCropLeft + deltaX;
          break;
        case 'bottom-right':
          newWidth = state.startCropWidth + deltaX;
          newHeight = state.startCropHeight + deltaY;
          break;
      }

      // æ­£æ–¹å½¢ã‚’ä¿ã¤ï¼ˆå¹³å‡å€¤ã‚’ä½¿ç”¨ï¼‰
      const newSize = (newWidth + newHeight) / 2;

      // æœ€å°ã‚µã‚¤ã‚ºåˆ¶é™
      const minSize = 200;
      const maxSize = 800;
      const clampedSize = Math.max(minSize, Math.min(maxSize, newSize));

      // ä¸­å¿ƒä½ç½®ã‚’ä¿ã¤ã‚ˆã†ã« left/top ã‚’èª¿æ•´
      const sizeDiff = clampedSize - state.startCropWidth;
      const centerAdjustLeft = state.startCropLeft - sizeDiff / 2;
      const centerAdjustTop = state.startCropTop - sizeDiff / 2;

      // æ‹¡å¤§æ–¹å‘ï¼ˆåˆ‡ã‚ŠæŠœãç®‡æ‰€ã‚’å°ã•ãï¼‰ã‹ç¸®å°æ–¹å‘ï¼ˆåˆ‡ã‚ŠæŠœãç®‡æ‰€ã‚’å¤§ããï¼‰ã‹
      const isZoomingIn = clampedSize < state.startCropWidth;

      if (isZoomingIn) {
        // æ‹¡å¤§æ–¹å‘: ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—å¾Œã«é©ç”¨ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—ï¼‰
        state.pendingCropSize = {
          width: clampedSize,
          height: clampedSize,
          left: centerAdjustLeft,
          top: centerAdjustTop,
        };
      } else {
        // ç¸®å°æ–¹å‘: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        applyCropResize(clampedSize, clampedSize, centerAdjustLeft, centerAdjustTop);
      }
    });

    // ãƒªã‚µã‚¤ã‚ºçµ‚äº†
    document.addEventListener('mouseup', () => {
      if (!state.isResizing) return;

      state.isResizing = false;
      gridOverlay.classList.remove('visible');

      // æ‹¡å¤§æ–¹å‘ã®å ´åˆã€ã“ã“ã§é©ç”¨
      if (state.pendingCropSize) {
        applyCropResize(
          state.pendingCropSize.width,
          state.pendingCropSize.height,
          state.pendingCropSize.left,
          state.pendingCropSize.top
        );
        state.pendingCropSize = null;
      }
    });

    // ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®ãƒªã‚µã‚¤ã‚ºã‚’é©ç”¨
    function applyCropResize(newWidth, newHeight, newLeft, newTop) {
      // ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã®ã‚µã‚¤ã‚ºå¤‰æ›´
      cropAreaState.width = newWidth;
      cropAreaState.height = newHeight;
      cropAreaState.left = newLeft;
      cropAreaState.top = newTop;

      cropArea.style.width = `${newWidth}px`;
      cropArea.style.height = `${newHeight}px`;
      cropArea.style.left = `${newLeft}px`;
      cropArea.style.top = `${newTop}px`;

      // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®ã‚‚ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã¨åŒæœŸ
      imageContainer.style.left = `${newLeft}px`;
      imageContainer.style.top = `${newTop}px`;
      imageContainer.style.width = `${newWidth}px`;
      imageContainer.style.height = `${newHeight}px`;

      // ç”»åƒã® scale ã‚’èª¿æ•´ï¼ˆã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸãŒå°ã•ããªã‚‹ = æ‹¡å¤§ï¼‰
      const minDimension = Math.min(IMAGE_WIDTH, IMAGE_HEIGHT);
      const newInitialScale = newWidth / minDimension;
      const scaleRatio = newInitialScale / INITIAL_SCALE;

      // æ–°ã—ã„åˆæœŸé…ç½®ã‚’è¨ˆç®—ï¼ˆtransform-origin: 50% 50% ã®å ´åˆï¼‰
      const imageCenterX = IMAGE_WIDTH / 2;
      const imageCenterY = IMAGE_HEIGHT / 2;
      const containerCenterX = newWidth / 2;
      const containerCenterY = newHeight / 2;

      INITIAL_TRANSLATE_X = containerCenterX - imageCenterX;
      INITIAL_TRANSLATE_Y = containerCenterY - imageCenterY;
      INITIAL_SCALE = newInitialScale;

      state.scale = newInitialScale;

      // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ã«å¿œã˜ã¦ translate ã‚’èª¿æ•´ï¼ˆç›¸å¯¾çš„ãªä½ç½®ã‚’ä¿ã¤ï¼‰
      const newX = state.x * scaleRatio;
      const newY = state.y * scaleRatio;

      // ãƒªã‚µã‚¤ã‚ºå¾Œã®ãƒ‰ãƒ©ãƒƒã‚°ç¯„å›²ã‚’åˆ¶é™
      const clamped = clampTranslate(newX, newY);
      state.x = clamped.x;
      state.y = clamped.y;

      applyTransform(true);
    }

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    resetBtn.addEventListener('click', () => {
      // ã‚¯ãƒ­ãƒƒãƒ—é ˜åŸŸã‚’ãƒªã‚»ãƒƒãƒˆ
      cropAreaState = { ...CROP_AREA_INITIAL };
      cropArea.style.width = `${CROP_AREA_INITIAL.width}px`;
      cropArea.style.height = `${CROP_AREA_INITIAL.height}px`;
      cropArea.style.left = `${CROP_AREA_INITIAL.left}px`;
      cropArea.style.top = `${CROP_AREA_INITIAL.top}px`;

      // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã‚‚ãƒªã‚»ãƒƒãƒˆ
      imageContainer.style.left = `${CROP_AREA_INITIAL.left}px`;
      imageContainer.style.top = `${CROP_AREA_INITIAL.top}px`;
      imageContainer.style.width = `${CROP_AREA_INITIAL.width}px`;
      imageContainer.style.height = `${CROP_AREA_INITIAL.height}px`;

      // åˆæœŸé…ç½®ã‚’å†è¨ˆç®—ï¼ˆtransform-origin: 50% 50% ã®å ´åˆï¼‰
      const cropAreaSize = CROP_AREA_INITIAL.width;
      const minDimension = Math.min(IMAGE_WIDTH, IMAGE_HEIGHT);
      INITIAL_SCALE = cropAreaSize / minDimension;

      const imageCenterX = IMAGE_WIDTH / 2;
      const imageCenterY = IMAGE_HEIGHT / 2;
      const containerCenterX = cropAreaSize / 2;
      const containerCenterY = cropAreaSize / 2;

      INITIAL_TRANSLATE_X = containerCenterX - imageCenterX;
      INITIAL_TRANSLATE_Y = containerCenterY - imageCenterY;

      // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      state.x = 0;
      state.y = 0;
      state.scale = INITIAL_SCALE;
      state.rotation = 0;

      applyTransform(true);
    });

    // ç”»åƒåˆ‡ã‚Šæ›¿ãˆé–¢æ•°ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚ã‚Šï¼‰
    function changeImage(width, height) {
      showLoading();

      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const allButtons = document.querySelectorAll('button');
      allButtons.forEach(btn => btn.disabled = true);

      // æ–°ã—ã„ç”»åƒã‚’èª­ã¿è¾¼ã¿
      const newSrc = `https://picsum.photos/${width}/${height}?random=${Date.now()}`;

      // ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
      cropperImage.onload = () => {
        hideLoading();
        // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        allButtons.forEach(btn => btn.disabled = false);
      };

      cropperImage.onerror = () => {
        hideLoading();
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        allButtons.forEach(btn => btn.disabled = false);
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      };

      cropperImage.src = newSrc;
    }

    // ç¸¦é•·ç”»åƒãƒœã‚¿ãƒ³
    verticalBtn.addEventListener('click', () => {
      changeImage(640, 1136);
    });

    // æ¨ªé•·ç”»åƒãƒœã‚¿ãƒ³
    horizontalBtn.addEventListener('click', () => {
      changeImage(1136, 640);
    });

    // æ­£æ–¹å½¢ç”»åƒãƒœã‚¿ãƒ³
    squareBtn.addEventListener('click', () => {
      changeImage(800, 800);
    });

    // åˆæœŸè¡¨ç¤º
    applyTransform(false);
  </script>
</body>
</html>
